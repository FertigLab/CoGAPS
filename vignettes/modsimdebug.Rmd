---
title: "modsim cogaps debug"
author: "Jeanette Johnson"
date: "`r Sys.Date()`"
output: html_document
---

```{r include=FALSE, cache=FALSE}
# for now just see what happens with my already loaded version
library(CoGAPS)
library(BiocParallel)
packageVersion("CoGAPS")
```

In this file I am putting all code I use to debug reported issue with sparseOptimization-enabled CoGAPS. The issue has been reported to manifest with the ModSim dataset, with differing results returned depending on whether sparseOptimization was enabled. Optimization like this should in theory not effect the A and P matrices so it is a red flag that something deeper might be wrong. Tom fixed this issue a while back but the fix may not have propagated to the live version of CoGAPS. I'm basically trying to get to the bottom of the whole issue.

okay, first I'm gonna load the modsim dataset
```{r modsim}
modsimdata <- read.table("../data/ModSimData.txt")
modsimbases <- read.table("../data/ModSimBases.txt")
# input to CoGAPS
modsimdata
# P matrix output
modsimbases
```
The "bases" file contains only the P matrix, so we need to find the A matrix by division.
Data ~= A x P
so I believe that means
A ~= Data / P

A ~= Data * inverse(P)

"Moreover, as main use of the solve function is to solve a system of equations, if you want to calculate the solution to AA%*% X = BX=B you can type: solve(A, B)"
```{r compute missing matrix}
Amatrix = as.matrix(modsimdata) %*% as.matrix(t(modsimbases))
Pmatrix = as.matrix(modsimbases)
Datamatrix = as.matrix(modsimdata)
Amatrix <- solve(t(Pmatrix), Datamatrix)
```

Not really sure where to go with that actually. Isn't really giving me a matrix i can use.
```{r}
# create new parameters object
params <- new("CogapsParams")
# set the value for a specific parameter
params <- setParam(params, "nPatterns", 3)
params <- setParam(params, "seed", 42)
params <- setParam(params, "sparseOptimization", FALSE)
# params <- setFixedPatterns(params, Pmatrix, "P")
params

plainresult <- CoGAPS(modsimdata, params)
params <- setParam(params, "sparseOptimization", TRUE)
sparseoptimizedresult <- CoGAPS(modsimdata, params)

plainresult
sparseoptimizedresult
```

```{r test GIST data}
data(GIST)

params <- new("CogapsParams")
params <- setParam(params, "nPatterns", 5)
params <- setParam(params, "seed", 42)
params <- setParam(params, "sparseOptimization", FALSE)

plainGIST <- CoGAPS(GIST.matrix, params, uncertainty = GIST.uncertainty)

params <- setParam(params, "sparseOptimization", TRUE)
sparseoptimizedGIST <- CoGAPS(GIST.matrix, params)
```
